name: Issue Triage

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write
  contents: read

jobs:
  auto-label:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Add priority label based on keywords
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = (issue.body || '').toLowerCase();
            const title = (issue.title || '').toLowerCase();
            const text = title + ' ' + body;

            // Auto-label based on content
            const labels = [];

            // Priority detection
            if (text.includes('critical') || text.includes('urgent') || text.includes('broken')) {
              labels.push('priority:high');
            }

            // Component detection
            if (text.includes('plugin-dev')) labels.push('plugin:plugin-dev');
            if (text.includes('llmstxt')) labels.push('plugin:llmstxt');
            if (text.includes('openclaw')) labels.push('plugin:openclaw-docs');
            if (text.includes('documentation') || text.includes('docs')) labels.push('docs');
            if (text.includes('test') || text.includes('ci/cd') || text.includes('github actions')) labels.push('testing');

            // Add labels if any detected
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: labels
              });
            }

  notify-on-priority:
    runs-on: ubuntu-latest
    if: github.event.action == 'labeled' && github.event.label.name == 'priority:high'
    steps:
      - name: Comment on high priority issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸš¨ This issue has been marked as high priority and will be reviewed soon.'
            });

  welcome-first-issue:
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Welcome first-time contributors
        uses: actions/github-script@v7
        with:
          script: |
            const issueCreator = context.payload.issue.user.login;

            // Check if this is their first issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              creator: issueCreator,
              state: 'all'
            });

            if (issues.data.length === 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ðŸ‘‹ Thanks for opening your first issue! We appreciate your contribution to improving the plugin marketplace.

Please make sure you've provided all the requested information in the template. A maintainer will review this soon.`
              });
            }
